"use strict";(self.webpackChunknature_gram=self.webpackChunknature_gram||[]).push([[146],{1146:(Q,g,c)=>{c.r(g),c.d(g,{CommentsComponent:()=>L});var t=c(9468),m=c(6814),u=c(3315),h=c(8469),s=c(6976),_=c(4893);const f=["check",(0,c(9482).h)({outline:'<path d="M13.72,27.69,3.29,17.27a1,1,0,0,1,1.41-1.41l9,9L31.29,7.29a1,1,0,0,1,1.41,1.41Z"/>'})];var C=c(945),r=c(95),v=c(2616),b=c(3893),y=c(7715),T=c(3620);const O=["activity"];function M(e,a){if(1&e){const n=t.EpF();t.TgZ(0,"button",20,21),t.NdJ("click",function(){t.CHM(n);const o=t.MAs(1),d=t.oxw(2).$implicit,l=t.oxw();return t.KtG(l.agree(d.taxon,o))}),t._UZ(2,"cds-icon",22),t._uU(3,"agree"),t.qZA()}if(2&e){const n=t.oxw(3);t.Q6J("disabled",n.authServ.isExpired)}}function Z(e,a){if(1&e&&(t.ynx(0),t._UZ(1,"app-taxon",18),t.YNc(2,M,4,1,"button",19),t.BQk()),2&e){const n=t.oxw().$implicit;t.xp6(1),t.Q6J("taxon",n.taxon),t.xp6(1),t.Q6J("ngIf","supporting"!=n.category&&n.taxon.is_active)}}const p=function(e){return["naturalist",e]};function P(e,a){if(1&e&&(t.TgZ(0,"div",5,6)(2,"div",7)(3,"div",8)(4,"a",9),t._UZ(5,"img",10),t.qZA()(),t.TgZ(6,"div",11)(7,"p",12)(8,"a",13),t._uU(9),t.qZA(),t._uU(10," \u30fb "),t.TgZ(11,"span",14),t._uU(12),t.ALo(13,"async"),t.ALo(14,"dateTimeAgo"),t.qZA(),t._uU(15," \u30fb "),t.TgZ(16,"span",14),t._uU(17),t.qZA()()()(),t.TgZ(18,"div",15),t.YNc(19,Z,3,2,"ng-container",16),t._UZ(20,"p",17),t.qZA()()),2&e){const n=a.$implicit;t.xp6(4),t.Q6J("routerLink",t.VKq(13,p,n.user.login)),t.xp6(1),t.Q6J("src",n.user.icon||"assets/default.png",t.LSH),t.xp6(3),t.Q6J("routerLink",t.VKq(15,p,n.user.login)),t.xp6(1),t.Oqu(n.user.login),t.xp6(3),t.Oqu(t.lcZ(13,8,t.xi3(14,10,n.created_at,"short"))),t.xp6(5),t.Oqu(n.category),t.xp6(2),t.Q6J("ngIf",n.taxon),t.xp6(1),t.Q6J("innerHTML",n.body,t.oJD)}}function w(e,a){if(1&e){const n=t.EpF();t.ynx(0),t.TgZ(1,"div",35),t._UZ(2,"app-taxon",18),t.TgZ(3,"cds-icon",36),t.NdJ("click",function(){t.CHM(n);const o=t.oxw(2);return o.selectedTaxon=void 0,t.KtG(o.id=void 0)}),t.qZA()(),t.BQk()}if(2&e){const n=t.oxw(2);t.xp6(2),t.Q6J("taxon",n.selectedTaxon),t.xp6(1),t.uIk("shape","close")}}function A(e,a){if(1&e&&(t.ynx(0),t.TgZ(1,"p",39),t._uU(2,"computer"),t._UZ(3,"br"),t._uU(4," vision"),t._UZ(5,"br"),t._uU(6," score:"),t._UZ(7,"br"),t._uU(8),t.ALo(9,"number"),t.qZA(),t.BQk()),2&e){const n=t.oxw().$implicit;t.xp6(8),t.hij("",t.lcZ(9,1,n.combined_score),"%")}}function k(e,a){1&e&&(t.ynx(0),t.TgZ(1,"p",39),t._uU(2,"common ancestor"),t.qZA(),t.BQk())}function U(e,a){if(1&e){const n=t.EpF();t.TgZ(0,"div",37),t.NdJ("click",function(){const d=t.CHM(n).$implicit,l=t.oxw(2);return l.identify(d.taxon),t.KtG(l.isIdentifying=!1)}),t._UZ(1,"app-taxon",38),t.YNc(2,A,10,3,"ng-container",16),t.YNc(3,k,3,0,"ng-container",16),t.qZA()}if(2&e){const n=a.$implicit;t.xp6(1),t.Q6J("taxon",n.taxon),t.xp6(1),t.Q6J("ngIf",n.combined_score>0),t.xp6(1),t.Q6J("ngIf",n.common_ancestor)}}const S=function(e){return{"height.px":e}};function J(e,a){if(1&e){const n=t.EpF();t.TgZ(0,"div",23)(1,"div",24)(2,"div",25),t._UZ(3,"img",10),t.qZA(),t.TgZ(4,"div",11),t.YNc(5,w,4,2,"ng-container",16),t.TgZ(6,"div",26)(7,"button",27),t.NdJ("click",function(){t.CHM(n);const o=t.oxw();return o.getSuggestions(),t.KtG(o.isIdentifying=!0)}),t._UZ(8,"cds-icon"),t.qZA(),t.TgZ(9,"textarea",28,29),t.NdJ("ngModelChange",function(o){t.CHM(n);const d=t.oxw();return t.KtG(d.newComment=o)}),t._uU(11,"                "),t.qZA()()(),t.TgZ(12,"button",30),t.NdJ("click",function(){t.CHM(n);const o=t.oxw();return t.KtG(o.onSubmit())}),t._UZ(13,"cds-icon",22),t.qZA()(),t.TgZ(14,"div",31),t._UZ(15,"input",32),t.TgZ(16,"div",33),t.YNc(17,U,4,3,"div",34),t.qZA()()()}if(2&e){const n=t.MAs(10),i=t.oxw();t.xp6(3),t.Q6J("src",(null==i.authServ.me?null:i.authServ.me.icon)||"assets/default.png",t.LSH),t.xp6(2),t.Q6J("ngIf",i.selectedTaxon),t.xp6(2),t.Q6J("clrLoading",i.identBtnState),t.xp6(1),t.uIk("shape","bookmark"),t.xp6(1),t.Q6J("ngStyle",t.VKq(12,S,n.scrollHeight))("ngModel",i.newComment),t.xp6(3),t.Q6J("clrLoading",i.submitBtnState)("disabled",!i.newComment&&!i.id),t.xp6(2),t.ekj("display-inline-block",i.isIdentifying),t.xp6(1),t.Q6J("formControl",i.qTaxon),t.xp6(2),t.Q6J("ngForOf",i.suggestions)}}let L=(()=>{class e{constructor(n){this.changeDetectRef=n,this.authServ=(0,t.f3M)(C.Z),this.inatServ=(0,t.f3M)(v.E),this.newComment="",this.submitBtnState=s.xp5.DEFAULT,this.identBtnState=s.xp5.DEFAULT,this.loading=!0,this.combination=[],this.openIdentification=!1,this.suggestions=[],this.isIdentifying=!1,this.computerVision=[],this.qTaxon=new r.NI(""),this.sub=(0,y.D)(this.qTaxon.valueChanges).pipe((0,T.b)(300)).subscribe(this.searchTaxa.bind(this))}ngOnInit(){setTimeout(()=>{this.combination=this.comments.concat(...this.identifications).sort((n,i)=>Date.parse(n.created_at)-Date.parse(i.created_at)),0==this.combination.length&&(this.loading=!1)})}ngAfterViewInit(){this.activity.changes.subscribe(i=>{this.loading=!1,this.changeDetectRef.detectChanges()})}trackByItems(n,i){return i.uuid??i.id}agree(n,i){i.loadingStateChange(s.xp5.LOADING),this.inatServ.identification({identification:{taxon_id:n.id,observation_id:this.uuid}}).then(d=>{this.combination.push(...d)}).finally(()=>{i.loadingStateChange(s.xp5.DEFAULT)})}identify(n){this.id={identification:{taxon_id:n.id,observation_id:this.uuid}},this.selectedTaxon=n}onSubmit(){this.newComment&&!this.id?(this.submitBtnState=s.xp5.LOADING,this.inatServ.comment({fields:"string",comment:{parent_type:"Observation",parent_id:this.uuid,body:this.newComment}}).then(i=>{this.combination.push(...i)}).finally(()=>{this.newComment="",this.submitBtnState=s.xp5.DEFAULT})):this.id&&(this.submitBtnState=s.xp5.LOADING,this.id.identification.body=this.newComment,this.inatServ.identification(this.id).then(n=>{this.combination.push(...n)}).finally(()=>{this.qTaxon.reset(),this.suggestions=[],this.newComment="",this.submitBtnState=s.xp5.DEFAULT,this.id=void 0,this.selectedTaxon=void 0})),this.isIdentifying=!1}getSuggestions(){this.identBtnState=s.xp5.LOADING,this.computerVision.length?(this.suggestions=this.computerVision,this.identBtnState=s.xp5.DEFAULT):this.inatServ.getComputerVisionOnObs(this.uuid).then(n=>{this.suggestions=n,this.computerVision=n,console.log(this.suggestions)}).finally(()=>{this.identBtnState=s.xp5.DEFAULT})}searchTaxa(n){n?(this.identBtnState=s.xp5.LOADING,this.inatServ.taxaAutoComplete(n).then(i=>{this.suggestions=i.map(o=>({combined_score:0,taxon:o})),console.log(this.suggestions),0==i.length&&(this.qTaxon.setErrors({invalid:"No matching taxon found"}),this.suggestions=[])}).catch(i=>{this.suggestions=[],this.qTaxon.setErrors({invalid:i})}).finally(()=>{this.identBtnState=s.xp5.DEFAULT})):this.suggestions=this.computerVision}ngOnDestroy(){this.sub.unsubscribe()}}return e.\u0275fac=function(n){return new(n||e)(t.Y36(t.sBO))},e.\u0275cmp=t.Xpm({type:e,selectors:[["app-comments"]],viewQuery:function(n,i){if(1&n&&t.Gf(O,5),2&n){let o;t.iGM(o=t.CRH())&&(i.activity=o)}},inputs:{comments:"comments",identifications:"identifications",uuid:"uuid"},standalone:!0,features:[t.jDz],decls:6,vars:4,consts:[[1,"spinner-container"],[1,"spinner","spinner-md",3,"hidden"],[1,"activity-container"],["class","activity",4,"ngFor","ngForOf","ngForTrackBy"],["class","your-input",4,"ngIf"],[1,"activity"],["activity",""],[1,"clr-row","activity-header"],[1,"clr-col-auto"],[3,"routerLink"],[1,"user_icon",3,"src"],[1,"clr-col"],[1,"user-name"],[1,"p4",3,"routerLink"],[1,"p7"],[1,"activity-body"],[4,"ngIf"],[1,"p5",3,"innerHTML"],[3,"taxon"],["clrLoading","","class","btn btn-sm btn-success-outline btn-icon",3,"disabled","click",4,"ngIf"],["clrLoading","",1,"btn","btn-sm","btn-success-outline","btn-icon",3,"disabled","click"],["b",""],["shape","check"],[1,"your-input"],[1,"user-comment","clr-row","clr-align-items-center"],[1,"clr-col-auto","user-icon-container"],[1,"input-container"],[1,"btn","btn-sm","btn-icon","btn-primary-outline",3,"clrLoading","click"],["type","text","name","newcomment","rows","1","placeholder","Comment",1,"p5",3,"ngStyle","ngModel","ngModelChange"],["textarea",""],[1,"btn","btn-link","btn-sm","comment-btn","btn-icon",3,"clrLoading","disabled","click"],[1,"user-identification"],["type","text","placeholder","search taxon",1,"p5",3,"formControl"],[1,"search-list"],["class","card clickable",3,"click",4,"ngFor","ngForOf"],[1,"card","card-id"],[3,"click"],[1,"card","clickable",3,"click"],[1,"list-taxon",3,"taxon"],[1,"p7","score"]],template:function(n,i){1&n&&(t.TgZ(0,"div",0)(1,"span",1),t._uU(2," Loading... "),t.qZA()(),t.TgZ(3,"div",2),t.YNc(4,P,21,17,"div",3),t.qZA(),t.YNc(5,J,18,14,"div",4)),2&n&&(t.xp6(1),t.Q6J("hidden",!i.loading),t.xp6(3),t.Q6J("ngForOf",i.combination)("ngForTrackBy",i.trackByItems),t.xp6(1),t.Q6J("ngIf",!i.authServ.isExpired))},dependencies:[m.ez,m.sg,m.O5,m.PC,m.Ov,m.JJ,u.rH,h.i,s.K6A,s.q0d,s.nkF,s.cCV,s.MPb,r.UX,r.Fj,r.JJ,r.oH,r.u5,r.On,b.F],styles:[".user_icon[_ngcontent-%COMP%]{height:1rem;width:1rem;border-radius:50%}.user-icon-container[_ngcontent-%COMP%]{align-self:flex-start}p[_ngcontent-%COMP%]{margin-top:0!important}.taxon-common[_ngcontent-%COMP%]{line-height:.8rem!important}.taxon-container[_ngcontent-%COMP%]{display:flex;margin:.3rem 0}.taxon-img[_ngcontent-%COMP%]{width:1.8rem;height:1.8rem;align-self:center}.taxon-taxon[_ngcontent-%COMP%]{margin-left:.3rem!important}.taxon-name[_ngcontent-%COMP%]{margin-top:0!important}.clr-row[_ngcontent-%COMP%]{margin:0!important}.activity[_ngcontent-%COMP%]{margin:.3rem 0!important}.activity-body[_ngcontent-%COMP%]{margin-left:1.5rem}.activity-body[_ngcontent-%COMP%] > .p5[_ngcontent-%COMP%]{line-height:.8rem!important}.clr-col-auto[_ngcontent-%COMP%]{padding:0}a[_ngcontent-%COMP%]{text-decoration:unset}.comment-btn[_ngcontent-%COMP%]{padding:0!important;min-width:0;margin:0;align-self:end;width:1rem!important}.activity-container[_ngcontent-%COMP%]{display:flex;overflow-y:scroll;flex-direction:column;width:100%;margin-bottom:.5rem;flex:auto}.spinner-container[_ngcontent-%COMP%]{display:flex;justify-content:center}.container[_ngcontent-%COMP%]{display:flex;flex-direction:column;width:100%;flex:fit-content}.user-identification[_ngcontent-%COMP%]{padding:.3rem 0;display:none;width:100%}.search-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;overflow-y:scroll;height:60dvh;width:100%}.input-container[_ngcontent-%COMP%]{display:flex}.input-container[_ngcontent-%COMP%] > .btn[_ngcontent-%COMP%]{margin:0;width:1.5rem!important;padding:0;border:none!important}.card-id[_ngcontent-%COMP%]{padding:.3rem;margin-top:.2rem;display:flex;width:100%;margin-bottom:.2rem;box-shadow:none!important}.card-id[_ngcontent-%COMP%] > app-taxon[_ngcontent-%COMP%]{flex:auto}.input-container[_ngcontent-%COMP%] > textarea[_ngcontent-%COMP%]{border-radius:.2rem;border-style:hidden;background-color:#e8e8e8;margin-top:0!important;width:100%;padding-left:1.5rem;margin-left:-1.5rem}.user-identification[_ngcontent-%COMP%] > input[_ngcontent-%COMP%]{border-radius:.2rem;border-style:hidden;background-color:#e8e8e8;margin-top:0!important;width:100%}.search-list[_ngcontent-%COMP%] > .card[_ngcontent-%COMP%]{box-shadow:none!important;margin-top:.2rem;padding:0 .5rem;display:flex;width:100%}.list-taxon[_ngcontent-%COMP%]{flex:auto}.score[_ngcontent-%COMP%]{text-align:end;width:-moz-fit-content;width:fit-content}.display-inline-block[_ngcontent-%COMP%]{display:inline-block!important}.display-none[_ngcontent-%COMP%]{display:none!important}[_nghost-%COMP%]{display:flex;flex-direction:column;max-height:73dvh;width:100%!important}@media screen and (min-width: 768px){[_nghost-%COMP%]{max-width:20rem;max-height:75dvh}}"]}),e})();_.Q.addIcons(f)}}]);